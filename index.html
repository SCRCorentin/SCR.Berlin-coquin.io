<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Carte ‚Äî Interface valid√©e (-18)</title>

  <!-- Leaflet + plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    :root { --shadow: 0 4px 16px rgba(0,0,0,.18); }
    html, body, #map { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    /* Bottom dock (validated interface) */
    .dock {
      position: absolute;
      left: 8px; right: 8px;
      bottom: calc(8px + env(safe-area-inset-bottom, 0px));
      z-index: 1000;
      background: rgba(255,255,255,.96);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 8px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }
    .dock .row { display:flex; gap:8px; align-items:center; }
    .dock select, .dock button, .dock input[type="checkbox"] { font-size: 16px; }
    .dock select {
      flex:1;
      padding: 10px;
      border-radius: 10px; border: 1px solid #ddd; background: white;
    }
    .dock button {
      padding: 10px 12px;
      border-radius: 10px; border: 1px solid #ddd; background:white;
    }
    .dock label { font-size: 14px; }
    .dock .hint { font-size: 12px; color:#555; }

    .leaflet-control-geocoder { min-width: 220px; }
    @media (max-width: 420px) {
      .leaflet-control-geocoder { min-width: 170px; }
      .dock select, .dock button { font-size: 15px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Bottom dock -->
  <div class="dock leaflet-control" id="dock">
    <div class="row">
      <button id="locateBtn" title="Ma position">üìç</button>
      <button id="undoBtn" title="Supprimer le dernier point">‚Ü©Ô∏è</button>
      <button id="clearBtn" title="Effacer l‚Äôitin√©raire">‚ùå</button>
      <label><input type="checkbox" id="tapToggle" checked /> Tap = poser un point</label>
    </div>
    <div class="row">
      <select id="modeSel" title="Mode">
        <option value="walking" selected>Marche üö∂</option>
        <option value="cycling">V√©lo üö≤</option>
        <option value="driving">Voiture üöó</option>
      </select>
      <select id="destSel" title="Itin√©raire vers">
        <option value="">Itin√©raire vers‚Ä¶</option>
      </select>
    </div>
    <div class="row hint">
      Conseil : utilisez la loupe pour chercher une adresse. La dur√©e s‚Äôajuste selon le mode choisi.
    </div>
  </div>

  <!-- JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // ---- Lieux (6) : nom + adresse + site ----
    const places = [
      { name: "Ekstase Massagen",        address: "Ebertystra√üe 29, 10249 Berlin",           site: "https://www.ekstase-massage.de/" },
      { name: "Paris No. 5",              address: "Pariser Str. 3, 10719 Berlin",            site: "https://paris-no5.de/" },
      { name: "Primus Relax",             address: "Sickingenstra√üe 39, 10553 Berlin",        site: "https://primusrelaxmassage.de/" },
      { name: "NGel Massagen & Spa",      address: "Bismarckstra√üe 74/75, 10627 Berlin",      site: "https://ngel-massagen.de/" },
      { name: "Angelhands Spa",           address: "Friedrich-Wilhelm-Stra√üe 81A, 12103 Berlin", site: "https://angelhands-spa.de/" },
      { name: "Wolke 7 Massagen",         address: "Vo√üstra√üe 1, 10117 Berlin",               site: "https://www.wolke7-massage.de/" }
    ];

    // ---- Carte ----
    const map = L.map('map').setView([52.5076, 13.4], 12.5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    // Geocoder (loupe visible) - pour l'utilisateur
    const geocoderCtl = L.Control.geocoder({ defaultMarkGeocode: true, placeholder: "Chercher une adresse‚Ä¶" }).addTo(map);

    // Ic√¥ne SVG -18 (data URI)
    const adultIcon = L.icon({
      iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" viewBox="0 0 38 38">
          <defs><filter id="s" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity=".25"/></filter>
          </defs>
          <circle cx="19" cy="19" r="16" fill="#e11d48" filter="url(#s)"/>
          <text x="19" y="23" font-size="14" text-anchor="middle" fill="#fff"
                font-family="Arial, Helvetica, sans-serif" font-weight="700">-18</text>
        </svg>`),
      iconSize: [38, 38],
      iconAnchor: [19, 36],
      popupAnchor: [0, -30]
    });

    // Emp√™cher les clics √† travers les contr√¥les
    const dock = document.getElementById('dock');
    L.DomEvent.disableClickPropagation(dock);
    L.DomEvent.disableScrollPropagation(dock);
    setTimeout(() => {
      const gc = document.querySelector('.leaflet-control-geocoder');
      if (gc) {
        L.DomEvent.disableClickPropagation(gc);
        L.DomEvent.disableScrollPropagation(gc);
      }
    }, 0);

    // ---- Routing (validated) ----
    let currentProfile = 'walking';
    const routerFactory = (profile) => L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile });
    const formatter = new L.Routing.Formatter({ units: 'metric', language: 'fr' });
    const routingControl = L.Routing.control({
      router: routerFactory(currentProfile),
      routeWhileDragging: true,
      showAlternatives: true,
      collapsible: true,
      formatter,
      summaryTemplate: '<div><b>{name}</b><br><span id="lrm-mode">Mode: '+currentProfile+'</span><br>Distance: {distance}, Dur√©e: {time}</div>'
    }).addTo(map);

    function setProfile(profile){
      currentProfile = profile;
      routingControl.setRouter(routerFactory(currentProfile));
      const modeEl = document.getElementById('lrm-mode');
      if (modeEl) modeEl.textContent = 'Mode: ' + currentProfile;
      try { routingControl.route(); } catch(e) {}
    }
    document.getElementById('modeSel').addEventListener('change', (e) => setProfile(e.target.value));

    // Tap-to-add toggle (d√©sactive/active l'ajout de points par clic carte)
    let tapEnabled = true;
    document.getElementById('tapToggle').addEventListener('change', (e) => tapEnabled = e.target.checked);
    map.on('click', (e) => {
      if (!tapEnabled) return;
      if (e.originalEvent && e.originalEvent.target.closest && e.originalEvent.target.closest('.leaflet-control')) return;
      const wps = routingControl.getWaypoints();
      if (!wps[0].latLng) routingControl.setWaypoints([e.latlng]);
      else if (!wps[1].latLng) routingControl.setWaypoints([wps[0].latLng, e.latlng]);
      else routingControl.setWaypoints([wps[0].latLng, e.latlng]);
    });

    // Boutons
    document.getElementById('clearBtn').addEventListener('click', (e) => {
      e.preventDefault();
      routingControl.setWaypoints([]);
      destSel.value = "";
    });
    document.getElementById('undoBtn').addEventListener('click', (e) => {
      e.preventDefault();
      const wps = routingControl.getWaypoints();
      if (wps[1].latLng) routingControl.setWaypoints([wps[0].latLng]);
      else if (wps[0].latLng) routingControl.setWaypoints([]);
    });

    // Localisation (iOS/Safari-friendly)
    document.getElementById('locateBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if (!('geolocation' in navigator)) return alert('G√©olocalisation non support√©e.');
      if (!window.isSecureContext) return alert('HTTPS requis pour la g√©olocalisation.');
      const opts = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const ll = [pos.coords.latitude, pos.coords.longitude];
          map.setView(ll, 15);
          L.circleMarker(ll, {radius:7, color:'#333', fillColor:'#3af', fillOpacity:0.9}).addTo(map).bindPopup('Vous √™tes ici').openPopup();
        },
        (err) => {
          if (err.code === 1) alert('Autorisez la localisation dans R√©glages > Safari > Localisation.');
          else if (err.code === 2) alert('Position indisponible. R√©essayez pr√®s d‚Äôune fen√™tre.');
          else alert('D√©lai d√©pass√©. R√©essayez.');
        },
        opts
      );
    });

    // ---- G√©ocodage programmatique (Nominatim) pour placer les 6 points ----
    const NOMINATIM = "https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&countrycodes=de&q=";
    const delay = (ms) => new Promise(r => setTimeout(r, ms));

    const fg = L.featureGroup().addTo(map);
    const destSel = document.getElementById('destSel');
    const markers = []; // index -> marker

    function addPlaceMarker(p, idx, ll, displayName){
      const m = L.marker(ll, { icon: adultIcon, title: p.name }).addTo(fg).bindPopup(
        `<b>${p.name}</b><br>${p.address}<br>${p.site ? `<a href="${p.site}" target="_blank" rel="noopener">Site internet ‚Üó</a>` : ""}`
      );
      markers[idx] = m;

      const opt = document.createElement('option');
      opt.value = ll.lat + "," + ll.lng;
      opt.textContent = p.name;
      destSel.appendChild(opt);
    }

    async function geocodeAndAdd(p, idx){
      const url = NOMINATIM + encodeURIComponent(p.address);
      try {
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        if (Array.isArray(data) && data.length){
          const { lat, lon, display_name } = data[0];
          addPlaceMarker(p, idx, L.latLng(parseFloat(lat), parseFloat(lon)), display_name);
        } else {
          // fallback par nom
          const res2 = await fetch(NOMINATIM + encodeURIComponent(p.name + ", Berlin"), { headers: { "Accept":"application/json" } });
          const data2 = await res2.json();
          if (Array.isArray(data2) && data2.length){
            const { lat, lon, display_name } = data2[0];
            addPlaceMarker(p, idx, L.latLng(parseFloat(lat), parseFloat(lon)), display_name);
          }
        }
      } catch(e){ console.error("Geocoding √©chec:", p, e); }
    }

    (async () => {
      for (let i=0;i<places.length;i++){
        await geocodeAndAdd(places[i], i);
        await delay(1200); // throttle
      }
      if (fg.getLayers().length) map.fitBounds(fg.getBounds().pad(0.15));
    })();

    // ---- Lien "Itin√©raire vers‚Ä¶" ----
    destSel.addEventListener('change', () => {
      if (!destSel.value) return;
      const [lat, lon] = destSel.value.split(',').map(parseFloat);
      const dest = L.latLng(lat, lon);
      const wps = routingControl.getWaypoints();
      if (!wps[0].latLng) {
        routingControl.setWaypoints([map.getCenter(), dest]);
      } else {
        routingControl.setWaypoints([wps[0].latLng, dest]);
      }
    });
  </script>
</body>
</html>
